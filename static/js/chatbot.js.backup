// AI Tutor Chatbot Widget with Voice Support
class ChatbotWidget {
    constructor() {
        this.isOpen = false;
        this.messages = [];
        this.isListening = false;
        this.isSpeaking = false;
        this.autoSpeak = false; // Auto-speak bot responses
        this.initSpeechAPIs();
        this.init();
    }

    initSpeechAPIs() {
        // Initialize Speech Recognition (Voice Input)
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SpeechRecognition();
            this.recognition.continuous = false;
            this.recognition.interimResults = false;
            this.recognition.lang = 'en-US';

            this.recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                this.container.querySelector('.chatbot-input').value = transcript;
                this.isListening = false;
                this.updateVoiceButton();
            };

            this.recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                this.isListening = false;
                this.updateVoiceButton();
            };

            this.recognition.onend = () => {
                this.isListening = false;
                this.updateVoiceButton();
            };
        } else {
            console.warn('Speech recognition not supported in this browser');
        }

        // Initialize Text-to-Speech (Voice Output)
        if ('speechSynthesis' in window) {
            this.synthesis = window.speechSynthesis;
        } else {
            console.warn('Speech synthesis not supported in this browser');
        }
    }

    init() {
        this.createDOM();
        this.attachEventListeners();
        this.loadMessages();
    }

    createDOM() {
        const container = document.createElement('div');
        container.className = 'chatbot-widget-container';
        container.innerHTML = `
            <button class="chatbot-toggle-btn" title="Open AI Tutor">ðŸŽ“</button>
            <div class="chatbot-window">
                <div class="chatbot-header">
                    <div>
                        <h3>ðŸŽ“ AI Tutor</h3>
                        <small>Ask me anything about your studies!</small>
                    </div>
                    <div class="chatbot-header-controls">
                        <button class="chatbot-speaker-btn" title="Toggle auto-speak responses">
                            <span class="speaker-icon">ðŸ”‡</span>
                        </button>
                        <button class="chatbot-close-btn">âœ•</button>
                    </div>
                </div>
                <div class="chatbot-messages"></div>
                <div class="chatbot-input-area">
                    <button class="chatbot-voice-btn" title="Voice input">ðŸŽ¤</button>
                    <input 
                        type="text" 
                        class="chatbot-input" 
                        placeholder="Type or speak your question..."
                        autocomplete="off"
                    />
                    <button class="chatbot-send-btn">ðŸ“¤</button>
                </div>
            </div>
        `;
        document.body.appendChild(container);
        this.container = container;
    }

    attachEventListeners() {
        const toggleBtn = this.container.querySelector('.chatbot-toggle-btn');
        const closeBtn = this.container.querySelector('.chatbot-close-btn');
        const sendBtn = this.container.querySelector('.chatbot-send-btn');
        const voiceBtn = this.container.querySelector('.chatbot-voice-btn');
        const speakerBtn = this.container.querySelector('.chatbot-speaker-btn');
        const input = this.container.querySelector('.chatbot-input');

        toggleBtn.addEventListener('click', () => this.toggleChat());
        closeBtn.addEventListener('click', () => this.closeChat());
        sendBtn.addEventListener('click', () => this.sendMessage());
        voiceBtn.addEventListener('click', () => this.toggleVoiceInput());
        speakerBtn.addEventListener('click', () => this.toggleAutoSpeak());
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendMessage();
        });
    }

    toggleVoiceInput() {
        if (!this.recognition) {
            alert('Voice input is not supported in your browser. Please use Chrome or Edge.');
            return;
        }

        if (this.isListening) {
            this.recognition.stop();
            this.isListening = false;
        } else {
            this.recognition.start();
            this.isListening = true;
        }
        this.updateVoiceButton();
    }

    updateVoiceButton() {
        const voiceBtn = this.container.querySelector('.chatbot-voice-btn');
        if (this.isListening) {
            voiceBtn.innerHTML = 'ðŸ”´';
            voiceBtn.title = 'Listening...';
            voiceBtn.classList.add('listening');
        } else {
            voiceBtn.innerHTML = 'ðŸŽ¤';
            voiceBtn.title = 'Voice input';
            voiceBtn.classList.remove('listening');
        }
    }

    toggleAutoSpeak() {
        this.autoSpeak = !this.autoSpeak;
        const speakerBtn = this.container.querySelector('.chatbot-speaker-btn');
        const icon = speakerBtn.querySelector('.speaker-icon');
        
        if (this.autoSpeak) {
            icon.textContent = 'ðŸ”Š';
            speakerBtn.title = 'Auto-speak ON';
        } else {
            icon.textContent = 'ðŸ”‡';
            speakerBtn.title = 'Auto-speak OFF';
            // Stop any ongoing speech
            if (this.synthesis) {
                this.synthesis.cancel();
            }
        }
    }

    speak(text) {
        if (!this.synthesis || !this.autoSpeak) return;

        // Cancel any ongoing speech
        this.synthesis.cancel();

        // Create utterance
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9; // Slightly slower for better comprehension
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        // Try to use a female voice (more pleasant for tutoring)
        const voices = this.synthesis.getVoices();
        const preferredVoice = voices.find(voice => 
            voice.name.includes('Female') || 
            voice.name.includes('Samantha') ||
            voice.name.includes('Karen')
        );
        if (preferredVoice) {
            utterance.voice = preferredVoice;
        }

        this.synthesis.speak(utterance);
    }

    toggleChat() {
        if (this.isOpen) {
            this.closeChat();
        } else {
            this.openChat();
        }
    }

    openChat() {
        this.isOpen = true;
        const window = this.container.querySelector('.chatbot-window');
        const toggleBtn = this.container.querySelector('.chatbot-toggle-btn');
        window.classList.add('active');
        toggleBtn.classList.add('active');
        this.container.querySelector('.chatbot-input').focus();
    }

    closeChat() {
        this.isOpen = false;
        const window = this.container.querySelector('.chatbot-window');
        const toggleBtn = this.container.querySelector('.chatbot-toggle-btn');
        window.classList.remove('active');
        toggleBtn.classList.remove('active');
    }

    async sendMessage() {
        const input = this.container.querySelector('.chatbot-input');
        const message = input.value.trim();

        if (!message) return;

        // Add user message to UI
        this.addMessageToUI(message, 'user');
        input.value = '';

        // Show typing indicator
        this.showTypingIndicator();

        try {
            // Send message to backend
            console.log('[Chatbot] Sending message:', message);
            const response = await fetch('/api/chatbot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCookie('csrftoken')
                },
                body: JSON.stringify({ message: message })
            });

            console.log('[Chatbot] Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('[Chatbot] Error response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('[Chatbot] Received data:', data);
            
            // Remove typing indicator
            this.removeTypingIndicator();

            // Add bot response to UI
            this.addMessageToUI(data.reply, 'bot');

            // Speak the response if auto-speak is enabled
            if (this.autoSpeak) {
                this.speak(data.reply);
            }

            // Save message
            this.messages.push({
                user: message,
                bot: data.reply,
                timestamp: new Date().toISOString()
            });
            this.saveMessages();

        } catch (error) {
            console.error('Error:', error);
            this.removeTypingIndicator();
            this.addMessageToUI(
                'Sorry, I encountered an error. Please try again later.',
                'bot'
            );
        }
    }

        // Format message with line breaks preserved
        const formattedMessage = this.formatMessage(message);
        
        messageElement.innerHTML = `
            <div class="chatbot-message-content">${formattedMessage}</div>
            ${sender === 'bot' ? '<button class="speak-btn" title="Read aloud">ðŸ”Š</button>' : ''}
        `;
        
        // Add speak button listener for bot messages
        if (sender === 'bot') {
            const speakBtn = messageElement.querySelector('.speak-btn');
            speakBtn.addEventListener('click', () => this.speak(message));
        }
        
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    formatMessage(text) {
        // Convert newlines to <br> and preserve formatting
        return this.escapeHtml(text)
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
            .replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italic text'.chatbot-messages');
        const messageElement = document.createElement('div');
        messageElement.className = `chatbot-message ${sender}`;
        messageElement.innerHTML = `<div class="chatbot-message-content">${this.escapeHtml(message)}</div>`;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    showTypingIndicator() {
        const messagesDiv = this.container.querySelector('.chatbot-messages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chatbot-message bot';
        typingDiv.innerHTML = `
            <div class="chatbot-message-content">
                <div class="chatbot-typing">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        typingDiv.id = 'typing-indicator';
        messagesDiv.appendChild(typingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    removeTypingIndicator() {
        const typingDiv = document.getElementById('typing-indicator');
        if (typingDiv) typingDiv.remove();
    }

    escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    saveMessages() {Tutor. I can help you with:\n\n Study any subject (Math, Science, Programming, etc.)\nCreate study plans and schedules\n Explain complex topics simply\nPractice problems and homework help\n Use voice input  or text\n\nWhat would you like to learn today?',
                'bot'
            );
        }
    }
}

// Initialize chatbot when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const chatbot = new ChatbotWidget();
    
    // Load voices for speech synthesis after a short delay
    if ('speechSynthesis' in window) {
        setTimeout(() => {
            window.speechSynthesis.getVoices();
        }, 100);
    }
});                this.messages.forEach(msg => {
                    this.addMessageToUI(msg.user, 'user');
                    this.addMessageToUI(msg.bot, 'bot');
                });
            } catch (e) {
                console.error('Error loading messages:', e);
            }
        } else {
            // Show welcome message
            const messagesDiv = this.container.querySelector('.chatbot-messages');
            this.addMessageToUI(
                'Hello! ðŸ‘‹ I\'m your AI Assistant. How can I help you today?',
                'bot'
            );
        }
    }
}

// Initialize chatbot when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const chatbot = new ChatbotWidget();
});
